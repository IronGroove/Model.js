/*
 * Model.js v0.1
 *
 * Copyright 2013 by Mykhaylo Gavrylyuk, http://www.irongroove.com
 * Licensed under the MIT license
 *
 * Date: Fri May  3 00:54:28 EEST 2013
 */

Model=function(){function e(e){return Object.prototype.toString.call(e)==="[object Array]"}function t(){var e,n,r,i,s,o,u=arguments[0]||{},a=1,f=arguments.length,l=false,c=Object.prototype.toString,h=Object.prototype.hasOwnProperty,p=Array.prototype.push,d=Array.prototype.slice,v=String.prototype.trim,m=Array.prototype.indexOf,g={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},y={isFunction:function(e){return y.type(e)==="function"},isArray:Array.isArray||function(e){return y.type(e)==="array"},isWindow:function(e){return e!=null&&e==e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return e==null?String(e):g[c.call(e)]||"object"},isPlainObject:function(e){if(!e||y.type(e)!=="object"||e.nodeType){return false}try{if(e.constructor&&!h.call(e,"constructor")&&!h.call(e.constructor.prototype,"isPrototypeOf")){return false}}catch(t){return false}var n;for(n in e){}return n===undefined||h.call(e,n)}};if(typeof u==="boolean"){l=u;u=arguments[1]||{};a=2}if(typeof u!=="object"&&!y.isFunction(u)){u={}}if(f===a){u=this;--a}for(a;a<f;a++){if((e=arguments[a])!=null){for(n in e){r=u[n];i=e[n];if(u===i){continue}if(l&&i&&(y.isPlainObject(i)||(s=y.isArray(i)))){if(s){s=false;o=r&&y.isArray(r)?r:[]}else{o=r&&y.isPlainObject(r)?r:{}}u[n]=t(l,o,i)}else if(i!==undefined){u[n]=i}}}}return u}function n(e){var t=Object.prototype.toString,n=Object.prototype.hasOwnProperty,r={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},i={isPlainObject:function(e){if(!e||(e==null?String(e):r[t.call(e)]||"object")!=="object"||e.nodeType){return false}try{if(e.constructor&&!n.call(e,"constructor")&&!n.call(e.constructor.prototype,"isPrototypeOf")){return false}}catch(i){return false}var s;for(s in e){}return s===undefined||n.call(e,s)}};return i.isPlainObject(e)}function s(e,t){this.code=e;this.message=t}function o(e){e._rawAttributes=[];e._validators={};e.errCodes={};e._callbacks={};e.prototype=e.__proto__=i.Class.prototype;this.errCodes=e.errCodes;this._cls=e}function u(e){function a(){if(this.constructor!=a){throw new s("C001","Instances should be created with keyword `new`!")}var e=this,t=this.constructor,i,o,u,f=true,l;e._data={};e._errors={};e._callbacks={};e._changes={};e._changesAfterValidation=true;if(arguments.length==0){u={}}else if(arguments.length==1){if(typeof arguments[0]=="boolean"){i=arguments[0];u={}}else if(n(arguments[0])){u=arguments[0]}else{throw new s("C002","When a Model Class constructor receives one argument, "+"it should be either a boolean persistance flag or "+"a data object!")}}else if(arguments.length==2){if(typeof arguments[0]=="boolean"&&n(arguments[1])){i=arguments[0];u=arguments[1]}else{throw new s("C003","When a Model Class constructor receives two arguments, "+"they should be a boolean persistance flag and a data object!")}}else{throw new s("C004","A Model Class constructor should be provided no more "+"than 2 arguments!")}for(o in u){if(t.attributeNames.indexOf(o)>=0){e._data[o]=u[o];f=false}}e._persisted=true;if(i===undefined){if(t.idAttr&&!u[t.idAttr]){e._persisted=false}}else if(i){if(t.idAttr){if(!u[t.idAttr]){e._persisted=false}}}else{e._persisted=false}if(e._persisted&&f){e._persisted=false}e._data2=l=function(){if(arguments.length==1&&arguments[0]===undefined){return e}return this.get.apply(this,arguments)};l.prototype=l.__proto__=r;e._trigger("initialize")}var t,r={},o,u;u=new i.ModelConfigurator(a);e.call(u,u);o=i.ModelConfigurator.processRawAttributes(a._rawAttributes);delete a._rawAttributes;a.idAttr=o.idAttr;a.requiredAttributes=o.requiredAttributes;a.attributeNames=o.attributeNames;a.attributeValidators=o.attributeValidators;for(t=0;t<a.attributeNames.length;t++){(function(e){r.__defineGetter__(e,function(){var t=this(undefined);return t._get(e)});r.__defineSetter__(e,function(t){var n=this(undefined);n._set(e,t)})})(a.attributeNames[t])}var f=new Function;f.prototype=i.InstancePrototype;a.prototype=new f;a.prototype.constructor=a;return a}function f(e,t){if(this.constructor!=f){throw new s("M001","New models should be created with keyword `new`!")}else{}if(typeof e!="string"||typeof t!="function"){throw new s("M002","`new Model` expects its 1st argument to be a string name of "+"a new class, and its 2nd argument to be a function!")}if(f._classes[e]){throw new s("M003","A Model with that name already exists!")}var n=new i.Class(t);n.className=e;f._classes[e]=n;return n}var r,i={};s.prototype.toString=function(){return this.code+": "+this.message};r=o;r.prototype.attr=function(){var t=this._cls,n=Array.prototype.slice.call(arguments),r=n.shift(),i,o,u={};if(typeof r!="string"){throw new s("MC201","1st argument of a `attr` method should be a string!")}i=r.match(/^([a-z]+)(\!?)(\+?)$/i);if(!i){throw new s("MC202","The attribute description `"+r+"` is incorrect!")}for(o=0;o<n.length;o++){switch(true){case typeof n[o]=="function":break;case typeof n[o]=="string"&&/^[a-z]+$/i.test(n[o]):break;case e(n[o])&&n[o].length==2&&typeof n[o][0]=="string"&&/^[a-z]+$/i.test(n[o][0]):break;default:throw new s("MC203","Argument "+(o+1)+" in description of the `"+i[0]+"` "+"attribute is not a correct validator!")}}t._rawAttributes.push({name:i[1],idAttr:i[2]=="!",required:i[3]=="+",validators:n})};r.processRawAttributes=function(t){var n,r,i,o,u,a={},l={},c=[],h=[],p=[],d;for(n=0;n<t.length;n++){i=t[n];a[i.name]=i}for(r in a){c.push(r);if(a[r].required)h.push(r);if(a[r].idAttr)p.push(r);l[r]=a[r].validators}if(p.length>1){throw new s("MC101","Only one of the described attributes should be marked with "+"the exlamation sign as an id attribute! "+"But there are "+p.length+": "+p.join(",")+".")}else if(p.length==1){d=p[0]}for(r in l){var o=l[r];for(n=0;n<o.length;n++){switch(true){case typeof o[n]=="function":continue;break;case e(o[n]):u=o[n][0];break;default:u=o[n]}if(!f._validators[u]){throw new s("MC102","Attributes, when described by name, should be described only with "+"existing validators! "+"Unknown validator `"+u+"`!")}}}if(d&&h.indexOf(d)==-1){h.push(d)}return{idAttr:d,attributeNames:c,requiredAttributes:h,attributeValidators:l}};u.prototype.bind=function(e,t){var n=this;if(arguments.length!=2||typeof e!="string"||f._eventNames.indexOf(e)==-1||typeof t!="function"){throw new s("C101","Class.bind accepts two arguments: a valid string eventName "+"and a function eventHandler! "+"Valid event names are: "+f._eventNames.join(",")+".")}if(n._callbacks[e]===undefined){n._callbacks[e]=[]}n._callbacks[e].push(t)};u.prototype.validate=function(){var t=this,n,r,i;if(arguments.length==0||arguments.length>2){throw new s("C102","Class.validate accepts either 1 argument, a model instance "+"of same Class, or 2 arguments, a valid string attribute name "+"and its a value to validate!")}else if(arguments.length==1){n=arguments[0];if(n.constructor!==t){throw new s("C103","Provided argument is not an instance of same class! "+"("+t.className+")")}var o,u={},r,a;for(o=0;o<t.attributeNames.length;o++){r=t.attributeNames[o];a=this.validate(r,n.data[r]);if(a!==undefined)u[r]=a}for(o in u)return u;return{}}else if(arguments.length==2){r=arguments[0];i=arguments[1];if(this.attributeNames.indexOf(r)==-1){throw new s("C104","Class.validate accepts two arguments: a valid string attributeName "+"and a value to validate!")}var o,l=t.attributeValidators[r],a,c;if(i===null||i===undefined){if(t.requiredAttributes.indexOf(r)>=0){return f.errCodes.NULL}else{return}}for(o=0;o<l.length;o++){c=l[o];if(typeof c=="string"){a=f._validators[c](i)}else if(e(c)){a=f._validators[c[0]](i,c[1])}else if(typeof c=="function"){a=c(i)}if(a!==undefined){return a}}}};var a={};a.__defineGetter__("isNew",function(){return!this._persisted});a.__defineGetter__("isPersisted",function(){return this._persisted&&!this.hasChanged});a._get=function(e){return this._data[e]};a._set=function(e,t,n){var r={};if(this._changesAfterValidation===true)this._changesAfterValidation={};this._changesAfterValidation[e]=t;if(this._data[e]!==t){if(this._changes[e]===t){delete this._changes[e];this._data[e]=t}else{if(this._changes[e]===undefined){this._changes[e]=this._data[e]}this._data[e]=t}if(n!==false){r[e]=t;this._trigger("change",r)}return true}return false};a.__defineGetter__("data",function(){return this._data2});a.__defineSetter__("data",function(e){if(!n(e)){throw new s("I201","instance.data= setter accepts plain objects only!")}var t=this.constructor,r=this,i={};for(var o in e){if(t.attributeNames.indexOf(o)>=0){if(r._set(o,e[o],false)===true){i[o]=e[o]}}}this._trigger("change",i)});a.__defineGetter__("hasChanged",function(){for(var e in this._changes)return true;return false});a.get=function(n){var r,i=this.constructor,s={},o=Array.prototype.slice.call(arguments);if(!o.length){return t({},this._data)}if(e(arguments[0])){o=arguments[0]}for(r=0;r<o.length;r++){if(i.attributeNames.indexOf(o[r])>=0){s[o[r]]=this._data[o[r]]}}return s};a.set=function(e,t){var r=this.constructor,e,i={};if(arguments.length==1&&n(arguments[0])){i=arguments[0]}else if(arguments.length==2){i[e]=t}for(e in i){if(r.attributeNames.indexOf(e)>=0){this._set(e,i[e],false)}}};a._persist=function(){if(this.hasChanged){this._changes={};this._changesAfterValidation={};this._trigger("persist")}};a._revert=function(){if(this.hasChanged){for(var e in this._changes){if(this._changes[e]===undefined){delete this._data[e]}else{this._data[e]=this._changes[e]}}this._changes={};this._changesAfterValidation={};this._trigger("revert")}};a.bind=function(e,t){if(typeof e!="string"||f._eventNames.indexOf(e)==-1||typeof t!="function"){throw new s("I202","instance.bind method should be provided with a valid "+"string eventName and a function handler!")}if(this._callbacks[e]===undefined){this._callbacks[e]=[]}this._callbacks[e].push(t)};a._trigger=function(){var e,t=this.constructor,n=Array.prototype.slice.call(arguments),r=n.shift();if(typeof r!="string"||f._eventNames.indexOf(r)==-1){throw new s("I203","instance._trigger should be provided a valid event name!")}if(t._callbacks[r]){for(e=0;e<t._callbacks[r].length;e++){t._callbacks[r][e].apply(this,n)}}if(this._callbacks[r]){for(e=0;e<this._callbacks[r].length;e++){this._callbacks[r][e].apply(this,n)}}};a.__defineGetter__("_hasChangedAfterValidation",function(){if(this._changesAfterValidation===true)return true;for(var e in this._changesAfterValidation)return true;return false});a.__defineGetter__("errors",function(){if(this._hasChangedAfterValidation){this._errors=this.constructor.validate(this);this._changesAfterValidation={}}return this._errors});a.__defineGetter__("isValid",function(){for(var e in this.errors)return false;return true});f._classes={};f._validators={};f._eventNames="initialize change persist revert".split(" ");f.errCodes={};f.errCodes.WRONG_TYPE="wrongtype";f.errCodes.NULL="null";f.errCodes.EMPTY="empty";f.errCodes.NOT_IN="notin";f.registerValidator=function(e,t){if(typeof e!="string"||!e.match(/^[a-zA-Z]+$/)||typeof t!="function"||!!f._validators[e]){throw new s("M101","`Model.registerValidator` expects its 1st argument to be "+"a [a-zA-Z]+ string name of a new validator, its 2nd argument to "+"be actual validator function!")}f._validators[e]=t};f.registerValidator("number",function(e){if(typeof e!="number")return f.errCodes.WRONG_TYPE});f.registerValidator("string",function(e){if(typeof e!="string")return f.errCodes.WRONG_TYPE});f.registerValidator("boolean",function(e){if(typeof e!="boolean")return f.errCodes.WRONG_TYPE});f.registerValidator("nonnull",function(e){if(e===null)return f.errCodes.NULL});f.registerValidator("nonempty",function(e){if(typeof e!="string")return;if(e.length==0)return f.errCodes.EMPTY});f.registerValidator("in",function(e,t){if(t.indexOf(e)==-1)return f.errCodes.NOT_IN});i.Class=u;i.ModelConfigurator=o;i.InstancePrototype=a;return f}()
